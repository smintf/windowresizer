var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
/// <reference path="../../typings/html5.d.ts" />
(function (context) {
    const POSITIONS = {
        center: 0,
        top: -1,
        left: -1,
        bottom: 1,
        right: 1,
    };
    const CONFIG = {
        WrapperID: 'window_resizer_tooltip_wrapper',
        StylesID: 'window_resizer_tooltip_styles',
        HideTimeout: 2000,
        ZoomFactor: 1,
        Position: ['bottom', 'right']
    };
    const SLOTS = {
        WindowWidth: null,
        WindowHeight: null,
        ViewportWidth: null,
        ViewportHeight: null,
        CloseButton: null,
        SettingsButton: null
    };
    const STATE = {
        NeedsUpdate: false,
        PendingHide: null
    };
    const Runtime = {
        addEventListener: function (listener) {
            !chrome.runtime.onMessage.hasListener(listener)
                && chrome.runtime.onMessage.addListener(listener);
        },
        removeEventListener: function (listener) {
            try {
                chrome.runtime.onMessage.removeListener(listener);
            }
            catch (ex) { }
        },
        invoke: function (action, parameters) {
            return new Promise((resolve, reject) => {
                chrome.runtime.sendMessage({ action, parameters }, resolve);
            });
        },
        getURL: function (asset) {
            return chrome.extension.getURL(asset);
        },
        extensionId: chrome.runtime.id,
    };
    let Tooltip = document.getElementById(CONFIG.WrapperID);
    let Styles = document.getElementById(CONFIG.StylesID);
    Tooltip && Tooltip.remove();
    Styles && Styles.remove();
    Promise.all([
        Runtime.invoke('tooltip-hide-delay'),
        Runtime.invoke('tooltip-position'),
        Runtime.invoke('get-zoom')
    ]).then(([delay, position, zoom]) => {
        CONFIG.HideTimeout = delay.data;
        CONFIG.Position = (position.data && position.data.length == 2) ? position.data : CONFIG.Position;
        CONFIG.ZoomFactor = context.devicePixelRatio / zoom.data;
        if (document.readyState !== 'complete') {
            document.addEventListener('readystatechange', _init);
        }
        else {
            _init();
        }
    });
    function _init() {
        return __awaiter(this, void 0, void 0, function* () {
            if (document.readyState !== 'complete') {
                return;
            }
            document.removeEventListener('readystatechange', _init);
            Styles = document.createElement('link');
            Styles.id = CONFIG.StylesID;
            Styles.rel = 'stylesheet';
            Styles.type = 'text/css';
            Styles.href = Runtime.getURL('assets/tpl/resize-tooltip.css');
            document.querySelector('head').appendChild(Styles);
            Tooltip = document.createElement('div');
            Tooltip.id = CONFIG.WrapperID;
            Tooltip.setAttribute('data-pos-y', CONFIG.Position[0]);
            Tooltip.setAttribute('data-pos-x', CONFIG.Position[1]);
            const TemplateSrc = yield (yield fetch(Runtime.getURL('assets/tpl/resize-tooltip.html'))).text();
            let ShadowRoot = Tooltip.attachShadow({ mode: 'closed' });
            ShadowRoot.innerHTML = TemplateSrc;
            // ShadowRoot.appendChild(document.importNode(template.content, true));
            ShadowRoot.querySelector('.logo').addEventListener('mousedown', _dragStart);
            SLOTS.WindowWidth = ShadowRoot.querySelector('.primary .width');
            SLOTS.WindowHeight = ShadowRoot.querySelector('.primary .height');
            SLOTS.ViewportWidth = ShadowRoot.querySelector('.secondary .width');
            SLOTS.ViewportHeight = ShadowRoot.querySelector('.secondary .height');
            SLOTS.CloseButton = ShadowRoot.querySelector('.close');
            SLOTS.SettingsButton = ShadowRoot.querySelector('.settings');
            document.body.appendChild(Tooltip);
            enable();
            function _dragStart(evt) {
                Tooltip.classList.add('dragging');
                document.addEventListener('mousemove', _dragUpdate);
                document.addEventListener('mouseup', _dragEnd);
                document.body.style.cursor = 'move';
            }
            function _dragEnd(evt) {
                Tooltip.classList.remove('dragging');
                document.removeEventListener('mousemove', _dragUpdate);
                document.removeEventListener('mouseup', _dragEnd);
                document.body.style.cursor = 'initial';
                Runtime.invoke('save-settings', {
                    tooltipPosition: CONFIG.Position
                });
            }
            function _dragUpdate(evt) {
                if (!evt.clientX && !evt.clientY) {
                    return;
                }
                evt.stopPropagation();
                evt.preventDefault();
                let xSegment = window.innerWidth / 3;
                let ySegment = window.innerHeight / 3;
                let xAxis = 'left';
                let yAxis = 'top';
                if (evt.clientX > xSegment * 1)
                    xAxis = 'center';
                if (evt.clientX > xSegment * 2)
                    xAxis = 'right';
                if (evt.clientY > ySegment * 1)
                    yAxis = 'center';
                if (evt.clientY > ySegment * 2)
                    yAxis = 'bottom';
                CONFIG.Position[0] != yAxis && Tooltip.setAttribute('data-pos-y', yAxis);
                CONFIG.Position[1] != xAxis && Tooltip.setAttribute('data-pos-x', xAxis);
                if (CONFIG.Position[0] != yAxis || CONFIG.Position[1] != xAxis) {
                    CONFIG.Position = [yAxis, xAxis];
                    Tooltip.style.transform = _getTransform();
                }
            }
        });
    }
    function _toggleEventListeners(state) {
        let action = state ? 'addEventListener' : 'removeEventListener';
        Runtime[action](handleExtensionRequest);
        context[action]('resize', update, false);
        Tooltip[action]('mouseover', showOn);
        Tooltip[action]('mouseout', delayedHide);
        SLOTS.CloseButton[action]('click', disable);
        SLOTS.SettingsButton[action]('click', openSettings);
    }
    function _getTransform() {
        const scale = CONFIG.ZoomFactor / context.devicePixelRatio;
        const posY = POSITIONS[CONFIG.Position[0]];
        const posX = POSITIONS[CONFIG.Position[1]];
        let left = posX * -24 + window.innerWidth / scale * (posX + 1) / 2 - Tooltip.offsetWidth / scale * (posX + 1) / 2;
        let top = posY * -24 + window.innerHeight / scale * (posY + 1) / 2 - Tooltip.offsetHeight / scale * (posY + 1) / 2;
        return `scale(${scale}) translateY(${top}px) translateX(${left}px)`;
    }
    function enable() {
        // read the opacity to kick-start the initial CSS fade-in animation
        // (it wouldn't otherwise animate when adding the `.visible` class right after
        // appending the node to the body - most likely because of some Chrome bug)
        context.getComputedStyle(Tooltip).opacity;
        _toggleEventListeners(true);
        //show();
    }
    function disable() {
        _toggleEventListeners(false);
        hide().then(() => {
            Tooltip.remove();
            Tooltip = null;
            Styles.remove();
            Styles = null;
        });
    }
    function openSettings() {
        Runtime.invoke('open-settings', '#settings/tooltip');
    }
    function show(autoHide) {
        Tooltip.classList.add('visible');
        cancelDelayedHide();
        update();
        autoHide !== false && delayedHide();
    }
    function showOn() {
        show(false);
    }
    function hide() {
        Tooltip.classList.remove('visible');
        cancelDelayedHide();
        STATE.NeedsUpdate = false;
        return new Promise((done) => setTimeout(done, 300));
    }
    function delayedHide() {
        cancelDelayedHide();
        STATE.PendingHide = setTimeout(hide, CONFIG.HideTimeout);
    }
    function cancelDelayedHide() {
        clearTimeout(STATE.PendingHide);
        STATE.PendingHide = null;
    }
    function update() {
        if (!Tooltip.parentNode) {
            disable();
            return;
        }
        if (!STATE.NeedsUpdate) {
            STATE.NeedsUpdate = true;
            context.requestAnimationFrame(_update);
        }
    }
    function _update() {
        STATE.NeedsUpdate = false;
        Tooltip.style.transform = _getTransform();
        SLOTS.WindowWidth.innerHTML = context.innerWidth;
        SLOTS.WindowHeight.innerHTML = context.innerHeight;
        SLOTS.ViewportWidth.innerHTML = context.outerWidth;
        SLOTS.ViewportHeight.innerHTML = context.outerHeight;
        !isVisible() && show();
    }
    function isVisible() {
        return Tooltip && Tooltip.classList.contains('visible');
    }
    function handleExtensionRequest(msg, sender, respond) {
        if (typeof msg === 'string') {
            msg = { command: msg };
        }
        switch (msg.command) {
            case 'STATUS':
                respond(isVisible() ? 'VISIBLE' : 'HIDDEN');
                break;
            case 'SET_HIDE_DELAY':
                CONFIG.HideTimeout = msg.delay || CONFIG.HideTimeout;
                break;
            case 'DISABLE':
                disable();
                break;
            case 'SHOW':
                show();
                break;
            case 'HIDE':
                hide();
                break;
            case 'TOGGLE':
                isVisible() ? hide() : show();
                break;
        }
    }
})(this);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9TY3JpcHRzL2VuYWJsZS10b29sdGlwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLGlEQUFpRDtBQUVqRCxDQUFDLFVBQVMsT0FBTztJQUNoQixNQUFNLFNBQVMsR0FBRztRQUNqQixNQUFNLEVBQUcsQ0FBQztRQUNWLEdBQUcsRUFBTSxDQUFDLENBQUM7UUFDWCxJQUFJLEVBQUssQ0FBQyxDQUFDO1FBQ1gsTUFBTSxFQUFHLENBQUM7UUFDVixLQUFLLEVBQUksQ0FBQztLQUNWLENBQUE7SUFFRCxNQUFNLE1BQU0sR0FBRztRQUNkLFNBQVMsRUFBSyxnQ0FBZ0M7UUFDOUMsUUFBUSxFQUFNLCtCQUErQjtRQUM3QyxXQUFXLEVBQUcsSUFBSTtRQUNsQixVQUFVLEVBQUksQ0FBQztRQUNmLFFBQVEsRUFBTSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUM7S0FDakMsQ0FBQztJQUVGLE1BQU0sS0FBSyxHQUFHO1FBQ2IsV0FBVyxFQUFNLElBQUk7UUFDckIsWUFBWSxFQUFLLElBQUk7UUFDckIsYUFBYSxFQUFJLElBQUk7UUFDckIsY0FBYyxFQUFHLElBQUk7UUFDckIsV0FBVyxFQUFNLElBQUk7UUFDckIsY0FBYyxFQUFHLElBQUk7S0FDckIsQ0FBQztJQUVGLE1BQU0sS0FBSyxHQUFHO1FBQ2IsV0FBVyxFQUFHLEtBQUs7UUFDbkIsV0FBVyxFQUFHLElBQUk7S0FDbEIsQ0FBQTtJQUVELE1BQU0sT0FBTyxHQUFHO1FBQ2YsZ0JBQWdCLEVBQUUsVUFBUyxRQUFRO1lBQ2xDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQzttQkFDM0MsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3BELENBQUM7UUFFRCxtQkFBbUIsRUFBRSxVQUFTLFFBQVE7WUFDckMsSUFBSTtnQkFDSCxNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDbEQ7WUFBQyxPQUFPLEVBQUUsRUFBRSxHQUFFO1FBQ2hCLENBQUM7UUFFRCxNQUFNLEVBQUUsVUFBUyxNQUFNLEVBQUUsVUFBVztZQUNuQyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO2dCQUN0QyxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUMzRCxDQUFDLENBQUMsQ0FBQTtRQUNILENBQUM7UUFFRCxNQUFNLEVBQUUsVUFBUyxLQUFLO1lBQ3JCLE9BQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkMsQ0FBQztRQUVELFdBQVcsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUU7S0FDOUIsQ0FBQTtJQUVELElBQUksT0FBTyxHQUE4QixRQUFRLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNuRixJQUFJLE1BQU0sR0FBc0MsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFekYsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUM1QixNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBRTFCLE9BQU8sQ0FBQyxHQUFHLENBQUM7UUFDWCxPQUFPLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDO1FBQ3BDLE9BQU8sQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUM7UUFDbEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUM7S0FDMUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQU0sRUFBRSxFQUFFO1FBQ3hDLE1BQU0sQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztRQUNoQyxNQUFNLENBQUMsUUFBUSxHQUFNLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztRQUNwRyxNQUFNLENBQUMsVUFBVSxHQUFJLE9BQU8sQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBRTFELElBQUksUUFBUSxDQUFDLFVBQVUsS0FBSyxVQUFVLEVBQUU7WUFDdkMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3JEO2FBQU07WUFDTixLQUFLLEVBQUUsQ0FBQztTQUNSO0lBQ0YsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFlLEtBQUs7O1lBQ25CLElBQUksUUFBUSxDQUFDLFVBQVUsS0FBSyxVQUFVLEVBQUU7Z0JBQ3ZDLE9BQU07YUFDTjtZQUVELFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUV4RCxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUN2QyxNQUFNLENBQUMsRUFBRSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUE7WUFDM0IsTUFBTSxDQUFDLEdBQUcsR0FBRyxZQUFZLENBQUE7WUFDekIsTUFBTSxDQUFDLElBQUksR0FBRyxVQUFVLENBQUE7WUFDeEIsTUFBTSxDQUFDLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLCtCQUErQixDQUFDLENBQUE7WUFDN0QsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUE7WUFFbEQsT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDeEMsT0FBTyxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDO1lBQzlCLE9BQU8sQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2RCxPQUFPLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFdkQsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0NBQWdDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUE7WUFDaEcsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFDLElBQUksRUFBRSxRQUFRLEVBQUMsQ0FBQyxDQUFDO1lBRXhELFVBQVUsQ0FBQyxTQUFTLEdBQUcsV0FBVyxDQUFBO1lBRWxDLHVFQUF1RTtZQUN2RSxVQUFVLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUU1RSxLQUFLLENBQUMsV0FBVyxHQUFNLFVBQVUsQ0FBQyxhQUFhLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUNuRSxLQUFLLENBQUMsWUFBWSxHQUFLLFVBQVUsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUNwRSxLQUFLLENBQUMsYUFBYSxHQUFJLFVBQVUsQ0FBQyxhQUFhLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUNyRSxLQUFLLENBQUMsY0FBYyxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsb0JBQW9CLENBQUMsQ0FBQztZQUN0RSxLQUFLLENBQUMsV0FBVyxHQUFNLFVBQVUsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDMUQsS0FBSyxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRTdELFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25DLE1BQU0sRUFBRSxDQUFDO1lBRVQsU0FBUyxVQUFVLENBQUMsR0FBRztnQkFDdEIsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ2xDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQ3BELFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7Z0JBQy9DLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7WUFDckMsQ0FBQztZQUVELFNBQVMsUUFBUSxDQUFDLEdBQUc7Z0JBQ3BCLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUNyQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUN2RCxRQUFRLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUNsRCxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO2dCQUV2QyxPQUFPLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRTtvQkFDL0IsZUFBZSxFQUFFLE1BQU0sQ0FBQyxRQUFRO2lCQUNoQyxDQUFDLENBQUM7WUFDSixDQUFDO1lBRUQsU0FBUyxXQUFXLENBQUMsR0FBRztnQkFDdkIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFO29CQUNqQyxPQUFPO2lCQUNQO2dCQUVELEdBQUcsQ0FBQyxlQUFlLEVBQUUsQ0FBQztnQkFDdEIsR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUVyQixJQUFJLFFBQVEsR0FBRyxNQUFNLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQztnQkFDckMsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7Z0JBQ3RDLElBQUksS0FBSyxHQUFNLE1BQU0sQ0FBQztnQkFDdEIsSUFBSSxLQUFLLEdBQU0sS0FBSyxDQUFDO2dCQUVyQixJQUFJLEdBQUcsQ0FBQyxPQUFPLEdBQUcsUUFBUSxHQUFHLENBQUM7b0JBQUUsS0FBSyxHQUFHLFFBQVEsQ0FBQztnQkFDakQsSUFBSSxHQUFHLENBQUMsT0FBTyxHQUFHLFFBQVEsR0FBRyxDQUFDO29CQUFFLEtBQUssR0FBRyxPQUFPLENBQUM7Z0JBRWhELElBQUksR0FBRyxDQUFDLE9BQU8sR0FBRyxRQUFRLEdBQUcsQ0FBQztvQkFBRSxLQUFLLEdBQUcsUUFBUSxDQUFDO2dCQUNqRCxJQUFJLEdBQUcsQ0FBQyxPQUFPLEdBQUcsUUFBUSxHQUFHLENBQUM7b0JBQUUsS0FBSyxHQUFHLFFBQVEsQ0FBQztnQkFFakQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ3pFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUV6RSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxFQUFFO29CQUMvRCxNQUFNLENBQUMsUUFBUSxHQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUNqQyxPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxhQUFhLEVBQUUsQ0FBQztpQkFDMUM7WUFDRixDQUFDO1FBQ0YsQ0FBQztLQUFBO0lBRUQsU0FBUyxxQkFBcUIsQ0FBQyxLQUFLO1FBQ25DLElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLHFCQUFxQixDQUFDO1FBRWhFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBQ3hDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDckMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUN6QyxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM1QyxLQUFLLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBRUQsU0FBUyxhQUFhO1FBQ3JCLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDO1FBQzNELE1BQU0sSUFBSSxHQUFJLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUMsTUFBTSxJQUFJLEdBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUU1QyxJQUFJLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFDLFVBQVUsR0FBRyxLQUFLLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxXQUFXLEdBQUcsS0FBSyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsSCxJQUFJLEdBQUcsR0FBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxLQUFLLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxZQUFZLEdBQUcsS0FBSyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVwSCxPQUFPLFNBQVMsS0FBSyxnQkFBZ0IsR0FBRyxrQkFBa0IsSUFBSSxLQUFLLENBQUM7SUFDckUsQ0FBQztJQUVELFNBQVMsTUFBTTtRQUNkLG1FQUFtRTtRQUNuRSw4RUFBOEU7UUFDOUUsMkVBQTJFO1FBQzNFLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFFMUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUIsU0FBUztJQUNWLENBQUM7SUFFRCxTQUFTLE9BQU87UUFDZixxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ2hCLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNqQixPQUFPLEdBQUcsSUFBSSxDQUFDO1lBRWYsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ2hCLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFDZixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCxTQUFTLFlBQVk7UUFDcEIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsU0FBUyxJQUFJLENBQUMsUUFBUztRQUN0QixPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNqQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ3BCLE1BQU0sRUFBRSxDQUFDO1FBRVQsUUFBUSxLQUFLLEtBQUssSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0lBRUQsU0FBUyxNQUFNO1FBQ2QsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2IsQ0FBQztJQUVELFNBQVMsSUFBSTtRQUNaLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BDLGlCQUFpQixFQUFFLENBQUM7UUFDcEIsS0FBSyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7UUFFMUIsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxTQUFTLFdBQVc7UUFDbkIsaUJBQWlCLEVBQUUsQ0FBQztRQUNwQixLQUFLLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFRCxTQUFTLGlCQUFpQjtRQUN6QixZQUFZLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2hDLEtBQUssQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQzFCLENBQUM7SUFFRCxTQUFTLE1BQU07UUFDZCxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRTtZQUN4QixPQUFPLEVBQUUsQ0FBQztZQUNWLE9BQU87U0FDUDtRQUVELElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFO1lBQ3ZCLEtBQUssQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1lBQ3pCLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN2QztJQUNGLENBQUM7SUFFRCxTQUFTLE9BQU87UUFDZixLQUFLLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztRQUUxQixPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxhQUFhLEVBQUUsQ0FBQztRQUUxQyxLQUFLLENBQUMsV0FBVyxDQUFDLFNBQVMsR0FBTSxPQUFPLENBQUMsVUFBVSxDQUFDO1FBQ3BELEtBQUssQ0FBQyxZQUFZLENBQUMsU0FBUyxHQUFLLE9BQU8sQ0FBQyxXQUFXLENBQUM7UUFDckQsS0FBSyxDQUFDLGFBQWEsQ0FBQyxTQUFTLEdBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQztRQUNwRCxLQUFLLENBQUMsY0FBYyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO1FBRXJELENBQUMsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVELFNBQVMsU0FBUztRQUNqQixPQUFPLE9BQU8sSUFBSSxPQUFPLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRUQsU0FBUyxzQkFBc0IsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLE9BQU87UUFDbkQsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLEVBQUU7WUFDNUIsR0FBRyxHQUFHLEVBQUMsT0FBTyxFQUFFLEdBQUcsRUFBQyxDQUFBO1NBQ3BCO1FBRUQsUUFBUSxHQUFHLENBQUMsT0FBTyxFQUFFO1lBQ3BCLEtBQUssUUFBUTtnQkFDWixPQUFPLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzdDLE1BQU07WUFFTixLQUFLLGdCQUFnQjtnQkFDcEIsTUFBTSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxXQUFXLENBQUM7Z0JBQ3RELE1BQU07WUFFTixLQUFLLFNBQVM7Z0JBQ2IsT0FBTyxFQUFFLENBQUM7Z0JBQ1gsTUFBTTtZQUVOLEtBQUssTUFBTTtnQkFDVixJQUFJLEVBQUUsQ0FBQztnQkFDUixNQUFNO1lBRU4sS0FBSyxNQUFNO2dCQUNWLElBQUksRUFBRSxDQUFDO2dCQUNSLE1BQU07WUFFTixLQUFLLFFBQVE7Z0JBQ1osU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDL0IsTUFBTTtTQUNOO0lBQ0YsQ0FBQztBQUNGLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDIiwiZmlsZSI6InNjcmlwdHMvZW5hYmxlLXRvb2x0aXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vdHlwaW5ncy9odG1sNS5kLnRzXCIgLz5cclxuXHJcbihmdW5jdGlvbihjb250ZXh0KSB7XHJcblx0Y29uc3QgUE9TSVRJT05TID0ge1xyXG5cdFx0Y2VudGVyIDogMCxcclxuXHRcdHRvcCAgICA6IC0xLFxyXG5cdFx0bGVmdCAgIDogLTEsXHJcblx0XHRib3R0b20gOiAxLFxyXG5cdFx0cmlnaHQgIDogMSxcclxuXHR9XHJcblxyXG5cdGNvbnN0IENPTkZJRyA9IHtcclxuXHRcdFdyYXBwZXJJRCAgIDogJ3dpbmRvd19yZXNpemVyX3Rvb2x0aXBfd3JhcHBlcicsXHJcblx0XHRTdHlsZXNJRCAgICA6ICd3aW5kb3dfcmVzaXplcl90b29sdGlwX3N0eWxlcycsXHJcblx0XHRIaWRlVGltZW91dCA6IDIwMDAsXHJcblx0XHRab29tRmFjdG9yICA6IDEsXHJcblx0XHRQb3NpdGlvbiAgICA6IFsnYm90dG9tJywgJ3JpZ2h0J11cclxuXHR9O1xyXG5cclxuXHRjb25zdCBTTE9UUyA9IHtcclxuXHRcdFdpbmRvd1dpZHRoICAgIDogbnVsbCxcclxuXHRcdFdpbmRvd0hlaWdodCAgIDogbnVsbCxcclxuXHRcdFZpZXdwb3J0V2lkdGggIDogbnVsbCxcclxuXHRcdFZpZXdwb3J0SGVpZ2h0IDogbnVsbCxcclxuXHRcdENsb3NlQnV0dG9uICAgIDogbnVsbCxcclxuXHRcdFNldHRpbmdzQnV0dG9uIDogbnVsbFxyXG5cdH07XHJcblxyXG5cdGNvbnN0IFNUQVRFID0ge1xyXG5cdFx0TmVlZHNVcGRhdGUgOiBmYWxzZSxcclxuXHRcdFBlbmRpbmdIaWRlIDogbnVsbFxyXG5cdH1cclxuXHJcblx0Y29uc3QgUnVudGltZSA9IHtcclxuXHRcdGFkZEV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uKGxpc3RlbmVyKSB7XHJcblx0XHRcdCFjaHJvbWUucnVudGltZS5vbk1lc3NhZ2UuaGFzTGlzdGVuZXIobGlzdGVuZXIpXHJcblx0XHRcdFx0JiYgY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmFkZExpc3RlbmVyKGxpc3RlbmVyKTtcclxuXHRcdH0sXHJcblxyXG5cdFx0cmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24obGlzdGVuZXIpIHtcclxuXHRcdFx0dHJ5IHtcclxuXHRcdFx0XHRjaHJvbWUucnVudGltZS5vbk1lc3NhZ2UucmVtb3ZlTGlzdGVuZXIobGlzdGVuZXIpO1xyXG5cdFx0XHR9IGNhdGNoIChleCkge31cclxuXHRcdH0sXHJcblxyXG5cdFx0aW52b2tlOiBmdW5jdGlvbihhY3Rpb24sIHBhcmFtZXRlcnM/KSB7XHJcblx0XHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcblx0XHRcdFx0Y2hyb21lLnJ1bnRpbWUuc2VuZE1lc3NhZ2Uoe2FjdGlvbiwgcGFyYW1ldGVyc30sIHJlc29sdmUpO1xyXG5cdFx0XHR9KVxyXG5cdFx0fSxcclxuXHJcblx0XHRnZXRVUkw6IGZ1bmN0aW9uKGFzc2V0KSB7XHJcblx0XHRcdHJldHVybiBjaHJvbWUuZXh0ZW5zaW9uLmdldFVSTChhc3NldCk7XHJcblx0XHR9LFxyXG5cclxuXHRcdGV4dGVuc2lvbklkOiBjaHJvbWUucnVudGltZS5pZCxcclxuXHR9XHJcblxyXG5cdGxldCBUb29sdGlwOiBIVE1MRWxlbWVudCA9IDxIVE1MRWxlbWVudD4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoQ09ORklHLldyYXBwZXJJRCk7XHJcblx0bGV0IFN0eWxlczogSFRNTExpbmtFbGVtZW50ID0gPEhUTUxMaW5rRWxlbWVudD4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoQ09ORklHLlN0eWxlc0lEKTtcclxuXHJcblx0VG9vbHRpcCAmJiBUb29sdGlwLnJlbW92ZSgpO1xyXG5cdFN0eWxlcyAmJiBTdHlsZXMucmVtb3ZlKCk7XHJcblxyXG5cdFByb21pc2UuYWxsKFtcclxuXHRcdFJ1bnRpbWUuaW52b2tlKCd0b29sdGlwLWhpZGUtZGVsYXknKSxcclxuXHRcdFJ1bnRpbWUuaW52b2tlKCd0b29sdGlwLXBvc2l0aW9uJyksXHJcblx0XHRSdW50aW1lLmludm9rZSgnZ2V0LXpvb20nKVxyXG5cdF0pLnRoZW4oKFtkZWxheSwgcG9zaXRpb24sIHpvb21dOiBhbnkpID0+IHtcclxuXHRcdENPTkZJRy5IaWRlVGltZW91dCA9IGRlbGF5LmRhdGE7XHJcblx0XHRDT05GSUcuUG9zaXRpb24gICAgPSAocG9zaXRpb24uZGF0YSAmJiBwb3NpdGlvbi5kYXRhLmxlbmd0aCA9PSAyKSA/IHBvc2l0aW9uLmRhdGEgOiBDT05GSUcuUG9zaXRpb247XHJcblx0XHRDT05GSUcuWm9vbUZhY3RvciAgPSBjb250ZXh0LmRldmljZVBpeGVsUmF0aW8gLyB6b29tLmRhdGE7XHJcblxyXG5cdFx0aWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgIT09ICdjb21wbGV0ZScpIHtcclxuXHRcdFx0ZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIF9pbml0KTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdF9pbml0KCk7XHJcblx0XHR9XHJcblx0fSk7XHJcblxyXG5cdGFzeW5jIGZ1bmN0aW9uIF9pbml0KCkge1xyXG5cdFx0aWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgIT09ICdjb21wbGV0ZScpIHtcclxuXHRcdFx0cmV0dXJuXHJcblx0XHR9XHJcblxyXG5cdFx0ZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIF9pbml0KTtcclxuXHJcblx0XHRTdHlsZXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaW5rJylcclxuXHRcdFN0eWxlcy5pZCA9IENPTkZJRy5TdHlsZXNJRFxyXG5cdFx0U3R5bGVzLnJlbCA9ICdzdHlsZXNoZWV0J1xyXG5cdFx0U3R5bGVzLnR5cGUgPSAndGV4dC9jc3MnXHJcblx0XHRTdHlsZXMuaHJlZiA9IFJ1bnRpbWUuZ2V0VVJMKCdhc3NldHMvdHBsL3Jlc2l6ZS10b29sdGlwLmNzcycpXHJcblx0XHRkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkJykuYXBwZW5kQ2hpbGQoU3R5bGVzKVxyXG5cclxuXHRcdFRvb2x0aXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuXHRcdFRvb2x0aXAuaWQgPSBDT05GSUcuV3JhcHBlcklEO1xyXG5cdFx0VG9vbHRpcC5zZXRBdHRyaWJ1dGUoJ2RhdGEtcG9zLXknLCBDT05GSUcuUG9zaXRpb25bMF0pO1xyXG5cdFx0VG9vbHRpcC5zZXRBdHRyaWJ1dGUoJ2RhdGEtcG9zLXgnLCBDT05GSUcuUG9zaXRpb25bMV0pO1xyXG5cclxuXHRcdGNvbnN0IFRlbXBsYXRlU3JjID0gYXdhaXQgKGF3YWl0IGZldGNoKFJ1bnRpbWUuZ2V0VVJMKCdhc3NldHMvdHBsL3Jlc2l6ZS10b29sdGlwLmh0bWwnKSkpLnRleHQoKVxyXG5cdFx0bGV0IFNoYWRvd1Jvb3QgPSBUb29sdGlwLmF0dGFjaFNoYWRvdyh7bW9kZTogJ2Nsb3NlZCd9KTtcclxuXHJcblx0XHRTaGFkb3dSb290LmlubmVySFRNTCA9IFRlbXBsYXRlU3JjXHJcblxyXG5cdFx0Ly8gU2hhZG93Um9vdC5hcHBlbmRDaGlsZChkb2N1bWVudC5pbXBvcnROb2RlKHRlbXBsYXRlLmNvbnRlbnQsIHRydWUpKTtcclxuXHRcdFNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvcignLmxvZ28nKS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBfZHJhZ1N0YXJ0KTtcclxuXHJcblx0XHRTTE9UUy5XaW5kb3dXaWR0aCAgICA9IFNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvcignLnByaW1hcnkgLndpZHRoJyk7XHJcblx0XHRTTE9UUy5XaW5kb3dIZWlnaHQgICA9IFNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvcignLnByaW1hcnkgLmhlaWdodCcpO1xyXG5cdFx0U0xPVFMuVmlld3BvcnRXaWR0aCAgPSBTaGFkb3dSb290LnF1ZXJ5U2VsZWN0b3IoJy5zZWNvbmRhcnkgLndpZHRoJyk7XHJcblx0XHRTTE9UUy5WaWV3cG9ydEhlaWdodCA9IFNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvcignLnNlY29uZGFyeSAuaGVpZ2h0Jyk7XHJcblx0XHRTTE9UUy5DbG9zZUJ1dHRvbiAgICA9IFNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvcignLmNsb3NlJyk7XHJcblx0XHRTTE9UUy5TZXR0aW5nc0J1dHRvbiA9IFNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvcignLnNldHRpbmdzJyk7XHJcblxyXG5cdFx0ZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChUb29sdGlwKTtcclxuXHRcdGVuYWJsZSgpO1xyXG5cclxuXHRcdGZ1bmN0aW9uIF9kcmFnU3RhcnQoZXZ0KSB7XHJcblx0XHRcdFRvb2x0aXAuY2xhc3NMaXN0LmFkZCgnZHJhZ2dpbmcnKTtcclxuXHRcdFx0ZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgX2RyYWdVcGRhdGUpO1xyXG5cdFx0XHRkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgX2RyYWdFbmQpO1xyXG5cdFx0XHRkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICdtb3ZlJztcclxuXHRcdH1cclxuXHJcblx0XHRmdW5jdGlvbiBfZHJhZ0VuZChldnQpIHtcclxuXHRcdFx0VG9vbHRpcC5jbGFzc0xpc3QucmVtb3ZlKCdkcmFnZ2luZycpO1xyXG5cdFx0XHRkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBfZHJhZ1VwZGF0ZSk7XHJcblx0XHRcdGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBfZHJhZ0VuZCk7XHJcblx0XHRcdGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ2luaXRpYWwnO1xyXG5cclxuXHRcdFx0UnVudGltZS5pbnZva2UoJ3NhdmUtc2V0dGluZ3MnLCB7XHJcblx0XHRcdFx0dG9vbHRpcFBvc2l0aW9uOiBDT05GSUcuUG9zaXRpb25cclxuXHRcdFx0fSk7XHJcblx0XHR9XHJcblxyXG5cdFx0ZnVuY3Rpb24gX2RyYWdVcGRhdGUoZXZ0KSB7XHJcblx0XHRcdGlmICghZXZ0LmNsaWVudFggJiYgIWV2dC5jbGllbnRZKSB7XHJcblx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRldnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblx0XHRcdGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cclxuXHRcdFx0bGV0IHhTZWdtZW50ID0gd2luZG93LmlubmVyV2lkdGggLyAzO1xyXG5cdFx0XHRsZXQgeVNlZ21lbnQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgLyAzO1xyXG5cdFx0XHRsZXQgeEF4aXMgICAgPSAnbGVmdCc7XHJcblx0XHRcdGxldCB5QXhpcyAgICA9ICd0b3AnO1xyXG5cclxuXHRcdFx0aWYgKGV2dC5jbGllbnRYID4geFNlZ21lbnQgKiAxKSB4QXhpcyA9ICdjZW50ZXInO1xyXG5cdFx0XHRpZiAoZXZ0LmNsaWVudFggPiB4U2VnbWVudCAqIDIpIHhBeGlzID0gJ3JpZ2h0JztcclxuXHJcblx0XHRcdGlmIChldnQuY2xpZW50WSA+IHlTZWdtZW50ICogMSkgeUF4aXMgPSAnY2VudGVyJztcclxuXHRcdFx0aWYgKGV2dC5jbGllbnRZID4geVNlZ21lbnQgKiAyKSB5QXhpcyA9ICdib3R0b20nO1xyXG5cclxuXHRcdFx0Q09ORklHLlBvc2l0aW9uWzBdICE9IHlBeGlzICYmIFRvb2x0aXAuc2V0QXR0cmlidXRlKCdkYXRhLXBvcy15JywgeUF4aXMpO1xyXG5cdFx0XHRDT05GSUcuUG9zaXRpb25bMV0gIT0geEF4aXMgJiYgVG9vbHRpcC5zZXRBdHRyaWJ1dGUoJ2RhdGEtcG9zLXgnLCB4QXhpcyk7XHJcblxyXG5cdFx0XHRpZiAoQ09ORklHLlBvc2l0aW9uWzBdICE9IHlBeGlzIHx8IENPTkZJRy5Qb3NpdGlvblsxXSAhPSB4QXhpcykge1xyXG5cdFx0XHRcdENPTkZJRy5Qb3NpdGlvbiA9IFt5QXhpcywgeEF4aXNdO1xyXG5cdFx0XHRcdFRvb2x0aXAuc3R5bGUudHJhbnNmb3JtID0gX2dldFRyYW5zZm9ybSgpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBfdG9nZ2xlRXZlbnRMaXN0ZW5lcnMoc3RhdGUpIHtcclxuXHRcdGxldCBhY3Rpb24gPSBzdGF0ZSA/ICdhZGRFdmVudExpc3RlbmVyJyA6ICdyZW1vdmVFdmVudExpc3RlbmVyJztcclxuXHJcblx0XHRSdW50aW1lW2FjdGlvbl0oaGFuZGxlRXh0ZW5zaW9uUmVxdWVzdCk7XHJcblx0XHRjb250ZXh0W2FjdGlvbl0oJ3Jlc2l6ZScsIHVwZGF0ZSwgZmFsc2UpO1xyXG5cdFx0VG9vbHRpcFthY3Rpb25dKCdtb3VzZW92ZXInLCBzaG93T24pO1xyXG5cdFx0VG9vbHRpcFthY3Rpb25dKCdtb3VzZW91dCcsIGRlbGF5ZWRIaWRlKTtcclxuXHRcdFNMT1RTLkNsb3NlQnV0dG9uW2FjdGlvbl0oJ2NsaWNrJywgZGlzYWJsZSk7XHJcblx0XHRTTE9UUy5TZXR0aW5nc0J1dHRvblthY3Rpb25dKCdjbGljaycsIG9wZW5TZXR0aW5ncyk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBfZ2V0VHJhbnNmb3JtKCkge1xyXG5cdFx0Y29uc3Qgc2NhbGUgPSBDT05GSUcuWm9vbUZhY3RvciAvIGNvbnRleHQuZGV2aWNlUGl4ZWxSYXRpbztcclxuXHRcdGNvbnN0IHBvc1kgID0gUE9TSVRJT05TW0NPTkZJRy5Qb3NpdGlvblswXV07XHJcblx0XHRjb25zdCBwb3NYICA9IFBPU0lUSU9OU1tDT05GSUcuUG9zaXRpb25bMV1dO1xyXG5cclxuXHRcdGxldCBsZWZ0ID0gcG9zWCAqIC0yNCArIHdpbmRvdy5pbm5lcldpZHRoIC8gc2NhbGUgKiAocG9zWCArIDEpIC8gMiAtIFRvb2x0aXAub2Zmc2V0V2lkdGggLyBzY2FsZSAqIChwb3NYICsgMSkgLyAyO1xyXG5cdFx0bGV0IHRvcCAgPSBwb3NZICogLTI0ICsgd2luZG93LmlubmVySGVpZ2h0IC8gc2NhbGUgKiAocG9zWSArIDEpIC8gMiAtIFRvb2x0aXAub2Zmc2V0SGVpZ2h0IC8gc2NhbGUgKiAocG9zWSArIDEpIC8gMjtcclxuXHJcblx0XHRyZXR1cm4gYHNjYWxlKCR7c2NhbGV9KSB0cmFuc2xhdGVZKCR7dG9wfXB4KSB0cmFuc2xhdGVYKCR7bGVmdH1weClgO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gZW5hYmxlKCkge1xyXG5cdFx0Ly8gcmVhZCB0aGUgb3BhY2l0eSB0byBraWNrLXN0YXJ0IHRoZSBpbml0aWFsIENTUyBmYWRlLWluIGFuaW1hdGlvblxyXG5cdFx0Ly8gKGl0IHdvdWxkbid0IG90aGVyd2lzZSBhbmltYXRlIHdoZW4gYWRkaW5nIHRoZSBgLnZpc2libGVgIGNsYXNzIHJpZ2h0IGFmdGVyXHJcblx0XHQvLyBhcHBlbmRpbmcgdGhlIG5vZGUgdG8gdGhlIGJvZHkgLSBtb3N0IGxpa2VseSBiZWNhdXNlIG9mIHNvbWUgQ2hyb21lIGJ1ZylcclxuXHRcdGNvbnRleHQuZ2V0Q29tcHV0ZWRTdHlsZShUb29sdGlwKS5vcGFjaXR5O1xyXG5cclxuXHRcdF90b2dnbGVFdmVudExpc3RlbmVycyh0cnVlKTtcclxuXHRcdC8vc2hvdygpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gZGlzYWJsZSgpIHtcclxuXHRcdF90b2dnbGVFdmVudExpc3RlbmVycyhmYWxzZSk7XHJcblx0XHRoaWRlKCkudGhlbigoKSA9PiB7XHJcblx0XHRcdFRvb2x0aXAucmVtb3ZlKCk7XHJcblx0XHRcdFRvb2x0aXAgPSBudWxsO1xyXG5cclxuXHRcdFx0U3R5bGVzLnJlbW92ZSgpO1xyXG5cdFx0XHRTdHlsZXMgPSBudWxsO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBvcGVuU2V0dGluZ3MoKSB7XHJcblx0XHRSdW50aW1lLmludm9rZSgnb3Blbi1zZXR0aW5ncycsICcjc2V0dGluZ3MvdG9vbHRpcCcpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gc2hvdyhhdXRvSGlkZT8pIHtcclxuXHRcdFRvb2x0aXAuY2xhc3NMaXN0LmFkZCgndmlzaWJsZScpO1xyXG5cdFx0Y2FuY2VsRGVsYXllZEhpZGUoKTtcclxuXHRcdHVwZGF0ZSgpO1xyXG5cclxuXHRcdGF1dG9IaWRlICE9PSBmYWxzZSAmJiBkZWxheWVkSGlkZSgpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gc2hvd09uKCkge1xyXG5cdFx0c2hvdyhmYWxzZSk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBoaWRlKCkge1xyXG5cdFx0VG9vbHRpcC5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7XHJcblx0XHRjYW5jZWxEZWxheWVkSGlkZSgpO1xyXG5cdFx0U1RBVEUuTmVlZHNVcGRhdGUgPSBmYWxzZTtcclxuXHJcblx0XHRyZXR1cm4gbmV3IFByb21pc2UoKGRvbmUpID0+IHNldFRpbWVvdXQoZG9uZSwgMzAwKSk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBkZWxheWVkSGlkZSgpIHtcclxuXHRcdGNhbmNlbERlbGF5ZWRIaWRlKCk7XHJcblx0XHRTVEFURS5QZW5kaW5nSGlkZSA9IHNldFRpbWVvdXQoaGlkZSwgQ09ORklHLkhpZGVUaW1lb3V0KTtcclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIGNhbmNlbERlbGF5ZWRIaWRlKCkge1xyXG5cdFx0Y2xlYXJUaW1lb3V0KFNUQVRFLlBlbmRpbmdIaWRlKTtcclxuXHRcdFNUQVRFLlBlbmRpbmdIaWRlID0gbnVsbDtcclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIHVwZGF0ZSgpIHtcclxuXHRcdGlmICghVG9vbHRpcC5wYXJlbnROb2RlKSB7XHJcblx0XHRcdGRpc2FibGUoKTtcclxuXHRcdFx0cmV0dXJuO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmICghU1RBVEUuTmVlZHNVcGRhdGUpIHtcclxuXHRcdFx0U1RBVEUuTmVlZHNVcGRhdGUgPSB0cnVlO1xyXG5cdFx0XHRjb250ZXh0LnJlcXVlc3RBbmltYXRpb25GcmFtZShfdXBkYXRlKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGZ1bmN0aW9uIF91cGRhdGUoKSB7XHJcblx0XHRTVEFURS5OZWVkc1VwZGF0ZSA9IGZhbHNlO1xyXG5cclxuXHRcdFRvb2x0aXAuc3R5bGUudHJhbnNmb3JtID0gX2dldFRyYW5zZm9ybSgpO1xyXG5cclxuXHRcdFNMT1RTLldpbmRvd1dpZHRoLmlubmVySFRNTCAgICA9IGNvbnRleHQuaW5uZXJXaWR0aDtcclxuXHRcdFNMT1RTLldpbmRvd0hlaWdodC5pbm5lckhUTUwgICA9IGNvbnRleHQuaW5uZXJIZWlnaHQ7XHJcblx0XHRTTE9UUy5WaWV3cG9ydFdpZHRoLmlubmVySFRNTCAgPSBjb250ZXh0Lm91dGVyV2lkdGg7XHJcblx0XHRTTE9UUy5WaWV3cG9ydEhlaWdodC5pbm5lckhUTUwgPSBjb250ZXh0Lm91dGVySGVpZ2h0O1xyXG5cclxuXHRcdCFpc1Zpc2libGUoKSAmJiBzaG93KCk7XHJcblx0fVxyXG5cclxuXHRmdW5jdGlvbiBpc1Zpc2libGUoKSB7XHJcblx0XHRyZXR1cm4gVG9vbHRpcCAmJiBUb29sdGlwLmNsYXNzTGlzdC5jb250YWlucygndmlzaWJsZScpO1xyXG5cdH1cclxuXHJcblx0ZnVuY3Rpb24gaGFuZGxlRXh0ZW5zaW9uUmVxdWVzdChtc2csIHNlbmRlciwgcmVzcG9uZCkge1xyXG5cdFx0aWYgKHR5cGVvZiBtc2cgPT09ICdzdHJpbmcnKSB7XHJcblx0XHRcdG1zZyA9IHtjb21tYW5kOiBtc2d9XHJcblx0XHR9XHJcblxyXG5cdFx0c3dpdGNoIChtc2cuY29tbWFuZCkge1xyXG5cdFx0XHRjYXNlICdTVEFUVVMnOlxyXG5cdFx0XHRcdHJlc3BvbmQoaXNWaXNpYmxlKCkgPyAnVklTSUJMRScgOiAnSElEREVOJyk7XHJcblx0XHRcdGJyZWFrO1xyXG5cclxuXHRcdFx0Y2FzZSAnU0VUX0hJREVfREVMQVknOlxyXG5cdFx0XHRcdENPTkZJRy5IaWRlVGltZW91dCA9IG1zZy5kZWxheSB8fCBDT05GSUcuSGlkZVRpbWVvdXQ7XHJcblx0XHRcdGJyZWFrO1xyXG5cclxuXHRcdFx0Y2FzZSAnRElTQUJMRSc6XHJcblx0XHRcdFx0ZGlzYWJsZSgpO1xyXG5cdFx0XHRicmVhaztcclxuXHJcblx0XHRcdGNhc2UgJ1NIT1cnOlxyXG5cdFx0XHRcdHNob3coKTtcclxuXHRcdFx0YnJlYWs7XHJcblxyXG5cdFx0XHRjYXNlICdISURFJzpcclxuXHRcdFx0XHRoaWRlKCk7XHJcblx0XHRcdGJyZWFrO1xyXG5cclxuXHRcdFx0Y2FzZSAnVE9HR0xFJzpcclxuXHRcdFx0XHRpc1Zpc2libGUoKSA/IGhpZGUoKSA6IHNob3coKTtcclxuXHRcdFx0YnJlYWs7XHJcblx0XHR9XHJcblx0fVxyXG59KSh0aGlzKTtcclxuIl19
